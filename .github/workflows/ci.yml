name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      extensions: ${{ steps.filter.outputs.extensions }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          backend:
            - 'spiffworkflow-backend/**'
          frontend:
            - 'spiffworkflow-frontend/**'
          extensions:
            - 'extensions/m8flow-backend/**'
            - 'spiffworkflow-backend/**'

  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spiffworkflow-backend
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install uv
      run: pip install uv
    - name: Install dependencies
      run: uv sync --group dev
    - name: Lint with Ruff
      run: uv run ruff check .
    - name: Type check with MyPy
      run: uv run mypy .
    - name: Test with Pytest
      run: uv run pytest

  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spiffworkflow-frontend
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: spiffworkflow-frontend/package-lock.json
    - name: Install dependencies
      run: npm ci
    - name: Lint
      run: npm run lint
    - name: Test
      run: npm test

  extensions:
    needs: changes
    if: ${{ needs.changes.outputs.extensions == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spiffworkflow-backend
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install uv
      run: pip install uv
    - name: Install dependencies
      run: uv sync --group dev
    - name: Run Extension Tests
      # We run from spiffworkflow-backend to use its environment, but target the extension tests
      # We must set PYTHONPATH to include the backend source and the extension source
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd):$(pwd)/src:$(pwd)/../extensions/m8flow-backend/src
        uv run pytest ../extensions/m8flow-backend/tests
